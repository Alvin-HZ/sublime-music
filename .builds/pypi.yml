image: archlinux
packages:
  - python
  - xorg-server-xvfb
sources:
  - https://git.sr.ht/~sumner/offlinemsmtp
environment:
  REPO_NAME: sublime-music
# triggers:
#   - action: email
#     condition: failure
#     to: ~sumner/sublime-music-devel@lists.sr.ht
tasks:
  - setup: |
      cd ${REPO_NAME}
      echo "cd ${REPO_NAME}" >> ~/.buildenv

  - build: |
      python setup.py sdist

  - deploy-pypi: |
      ./cicd/run_if_tagged_with_version                             \
        "twine upload -r testpypi dist/*"                           \
        "twine upload dist/*"

  - verify-pypi: |
      ./cicd/run_if_tagged_with_version                             \
        "pip install ${REPO_NAME}"
